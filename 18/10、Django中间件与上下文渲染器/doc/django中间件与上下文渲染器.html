<html>
<head>
  <title>Evernote Export</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/306387 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="697"/>

<div>
<span><div><ul><li><span style="font-size: 16pt;">Django中间件（Middleware）</span></li><ul><li><span style="font-size: 16pt; font-weight: normal;">中间件，顾名思义，就是处在中间的一些软件。比如匹配到了URL，但是还没有执行view函数的时候，这个时候可以执行一些代码，这个代码就是中间件。</span></li><li><span style="font-size: 16pt; font-weight: normal;">Django已经内置了许多中间件，这些中间件已经可以满足90%以上的需求，如果你还不够，还可以定义自己的中间件，以下将对Django自带的中间件进行详细解释：</span></li></ul></ul><div style="margin-top: 1em; margin-bottom: 1em;"><ul><li><span style="font-size: 16pt;">django.middleware.security.SecurityMiddleware：一些安全设置，比如XSS脚本过滤。</span></li><li><span style="font-size: 16pt; font-family: Tahoma;">django.contrib.sessions.middleware.SessionMiddleware：session支持中间件，加入这个中间件，会在数据库中生成一个django_session的表。</span></li><li><a href="http://django.middleware.common.commonmiddleware/" style="font-size: 16pt; font-family: Tahoma;">django.middleware.common.CommonMiddleware</a><span style="font-size: 16pt;-en-paragraph:true;">：通用中间件，会处理一些</span><span style="font-size: 16pt;-en-paragraph:true;">URL</span><span style="font-size: 16pt;-en-paragraph:true;">，比如</span><a href="http://baidu.com/" style="font-size: 16pt; font-family: Tahoma;">baidu.com</a><span style="font-size: 16pt;-en-paragraph:true;">会自动的处理成</span><a href="http://www.baidu.com。比如/blog/111会处理成/blog/111/" style="font-size: 16pt; color: rgb(0, 0, 255);-en-paragraph:true;">www.baidu.com</a><a href="http://www.baidu.com。比如/blog/111会处理成/blog/111/" style="font-size: 16pt; color: rgb(0, 0, 255);-en-paragraph:true;">。比如</a><a href="http://www.baidu.com。比如/blog/111会处理成/blog/111/" style="font-size: 16pt; color: rgb(0, 0, 255); font-family: Calibri;-en-paragraph:true;">/blog/111</a><a href="http://www.baidu.com。比如/blog/111会处理成/blog/111/" style="font-size: 16pt; color: rgb(0, 0, 255);-en-paragraph:true;">会处理成</a><a href="http://www.baidu.com。比如/blog/111会处理成/blog/111/" style="font-size: 16pt; color: rgb(0, 0, 255); font-family: Calibri;-en-paragraph:true;">/blog/111/</a><span style="font-size: 16pt;-en-paragraph:true;">自动加上反斜杠。</span></li><li><span style="font-size: 16pt; font-family: Tahoma;">django.middleware.csrf.CsrfViewMiddleware：跨域请求伪造中间件。加入这个中间件，在提交表单的时候会必须加入csrf_token，cookie中也会生成一个名叫csrftoken的值，也会在header中加入一个HTTP_X_CSRFTOKEN的值来放置CSRF攻击。</span></li><li><span style="font-size: 16pt; font-family: Tahoma;">django.contrib.auth.middleware.AuthenticationMiddleware：用户授权中间件。他会在每个HttpRequest对象到达view之前添加当前登录用户的user属性，也就是你可以在view中通过request访问user。</span></li><li><span style="font-size: 16pt; font-family: Tahoma;">django.contrib.messages.middleware.MessageMiddleware：消息中间件。展示一些后台信息给前端页面。如果需要用到消息，还需要在INSTALLED_APPS中添加django.contrib.message才能有效。如果不需要，可以把这两个都删除。</span></li><li><span style="font-size: 16pt; font-family: Tahoma;">django.middleware.clickjacking.XFrameOptionsMiddleware：防止通过浏览器页面跨Frame出现clickjacking（欺骗点击）攻击出现。</span></li></ul><font face="Tahoma"><span style="font-size: 21.3333px;"><br/></span></font><ul><li><span style="font-size: 21.3333px; font-family: Tahoma;">中间件的执行顺序</span></li><ul><li><span style="font-size: 21.3333px; font-family: Tahoma;">在调用视图前，settings中配置的MIDDLEWARE数组顺序执行</span></li><li><span style="font-size: 21.3333px; font-family: Tahoma;">在调用视图后，中间件会按相反的顺序</span></li></ul></ul><div><br/></div><ul><li><span style="font-size: 21.3333px; font-family: Tahoma;">编写一个自定义的中间件</span></li><ul><li><span style="font-size: 21.3333px; font-family: Tahoma;">你可以定义一个独立的python类来作为一个自定义中间件</span></li><ul><li><span style="font-size: 16pt;">__init__(self, get_response):</span></li><ul><li><span style="font-size: 16pt;">中间件的初</span><span style="font-size: 16pt;">始化只会在django启动时调用一次，并且只接受get_response函数，所以一般都不会去重写它</span></li></ul><li><span style="font-size: 21.3333px;">__call__(self, resquest):</span></li></ul></ul></ul></div><div style="margin-top: 1em; margin-bottom: 1em;"><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 14pt;">def __call__(self, request):</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 14pt;">    # 在这里编写执行view视图需要处理的代码    </font></span></div><div><span style="font-family: Monaco;"><font style="font-size: 14pt;">    response = self.get_response(request)</font></span></div><div><font style="font-size: 14pt;">  # 在这里编写执行view视图后需要处理的代码</font></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 14pt;">    return response</font></span></div></div></div><div style="margin-top: 1em; margin-bottom: 1em;"><div>ps: <span style="font-family: Monaco; font-size: 9pt;">response = self.get_response(request) 必须要有</span></div><div><br/></div><ul><ul><li><span style="font-size: 21.3333px; font-family: Tahoma;">在调用视图前，他有以下函数</span></li><ul><li><span style="font-size: 16pt; font-family: Tahoma;">process_view(request, view_func, view_args, view_kwargs): return None or HttpResponse</span></li><ul><li><span style="font-size: 16pt; font-family: Tahoma;">在函数为你执行view视图前调用的方法</span></li></ul></ul><li><span style="font-size: 21.3333px; font-family: Tahoma;">调用视图之后</span></li><ul><li><span style="font-size: 16pt; font-family: Tahoma;">process_template_response(request, response) return 实现了render方法的HttpResponse</span></li><ul><li><span style="font-size: 16pt; font-family: Tahoma;">如果需要调用这个函数，返回的response必须包含render方法，一般该函数做模版内容处理</span></li></ul><li><span style="font-size: 16pt; font-family: Tahoma;">process_exception(request, exception): return None or HttpResponse</span></li><ul><li><span style="font-size: 16pt; font-family: Tahoma;">该请求在报出异常时，执行该方法</span></li></ul></ul></ul><li><span style="font-size: 21.3333px; font-family: Tahoma;">中间件开发准则</span></li><ul><li><span style="font-size: 16pt; font-family: Tahoma;">中间件的类不能是任何类的子类。</span></li><li><span style="font-size: 16pt; font-family: Tahoma;">中间件可以存在于你Python 路径中的任何位置。 Django所关心的只是被包含在MIDDLEWARE中的配置。</span></li><li><span style="font-size: 16pt; font-family: Tahoma;">将Django 中可用的中间件作为例子随便看看。<a href="https://docs.djangoproject.com/en/1.11/ref/middleware/" style="font-size: 16pt; font-family: Tahoma;">https://docs.djangoproject.com/en/1.11/ref/middleware/</a> </span></li><li><span style="font-size: 16pt; font-family: Tahoma;">如果你认为你写的中间件组建可能会对其他人有用，那就把它共享到社区！ 让我们知道它，我们会考虑把它添加到Django中</span></li><li><font style="font-family: Tahoma;"><span style="font-size: 21.3333px;">中间件一般是实现一个系统级别的应用或者面向整个工程应用，所以一般情况下，中间件不能有业务代码</span></font></li></ul></ul><font face="Tahoma"><span style="font-size: 21.3333px;"><br/></span></font><ul><li><span style="font-size: 21.3333px; font-family: Tahoma;">使用中间件开发流量统计</span></li><ul><li><span style="font-size: 21.3333px; font-family: Tahoma;">添加一个middleware类</span></li><ul><li><font style="font-size: 16pt;">你创建的类原则上是可以放置在任何路径，只要你能够引用，如果你要写自己的中间件，我们一般会在某个app下添加一个middleware文件或者创建一个文件夹，专门存储中间件文件</font></li></ul><li><span style="font-size: 21.3333px; font-family: Tahoma;">添加至settings</span></li></ul></ul><div><br/></div><div><br/></div><div><br/></div><ul><li><span style="font-size: 21.3333px; font-family: Tahoma;">Django上下文渲染器</span></li><ul><li><span style="font-size: 16pt;">有时候我们想让一些内容在多个模板中都要有，比如导航内容，我们又不想每个视图函数都写一次这些变量内容，怎么办呢？</span><span style="font-size: 16pt;">这时候就可以用 Django 上下文渲染器来解决。</span></li><li><span style="font-size: 21.3333px;">内置的上下文渲染器</span></li></ul></ul></div><div style="margin-top: 1em; margin-bottom: 1em;"><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">TEMPLATES = [</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        'BACKEND': 'django.template.backends.django.DjangoTemplates',</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        'DIRS': [os.path.join(BASE_DIR, 'templates')],</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        'APP_DIRS': True,</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        'OPTIONS': {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            </span><span style="font-family: Monaco; font-size: 9pt;"><font color="#FF0000">'context_processors': [</font></span></div><div><span style="font-family: Monaco; font-size: 9pt;"><font style="color: rgb(255, 0, 0);">                'django.template.context_processors.debug',</font></span></div><div><span style="font-family: Monaco; font-size: 9pt;"><font color="#FF0000">                'django.template.context_processors.request',</font></span></div><div><span style="font-family: Monaco; font-size: 9pt;"><font color="#FF0000">                'django.contrib.auth.context_processors.auth',</font></span></div><div><span style="font-family: Monaco; font-size: 9pt;"><font style="color: rgb(255, 0, 0);">                'django.contrib.messages.context_processors.messages',</font></span></div><div><span style="font-family: Monaco; font-size: 9pt;"><font color="#FF0000">            ],</font></span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        },</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    },</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">]</span></div></div></div><div style="margin-top: 1em; margin-bottom: 1em;"><div><br/></div><ul><li>django.template.context_processors.debug: 测试模块</li><ul><li>debug - True。你可以在模板中用它测试是否在DEBUG 模式。</li><li>sql_queries –  一个{'sql': ..., 'time': ...} 字典的列表，表示请求期间到目前为止发生的每个SQL 查询及花费的时间。这个列表按查询的顺序排序，并直到访问时才生成。</li></ul><li>django.template.context_processors.request： 处理请求模块</li><ul><li>requset - 表示当前的HttpRequest。</li></ul><li>django.contrib.auth.context_processors.auth： django内置的用户登录管理</li><ul><li>user – 一个 auth.User实例代表当前登录的用户 (或者 一个 AnonymousUser 实例, 如果用户没有登录).</li><li>perms – 一个 django.contrib.auth.context_processors.PermWrapper实例, 代表当前登录用户所拥有的权限.</li></ul><li>django.contrib.messages.context_processors.messages：</li><ul><li>messages – 通过消息框架设置的消息（字符串形式）列表。</li><li>DEFAULT_MESSAGE_LEVELS – 消息等级名称到它们数值 的映射。</li></ul></ul><div><br/></div></div><div style="margin-top: 1em; margin-bottom: 1em;"><ul><li><span style="font-size: 10pt;">编写一个自定义的上下文渲染器</span></li><ul><li>在工程内添加一个python文件，一般会添加到某个app下</li><ul><li>这里与中间同样的文件放置规则，默认是只要能够引用到的python文件即可，但是一般情况下，我们都会放置在一个app下，或者单独创建一个文件夹</li></ul><li>添加一个函数，它返回一个字典</li><li>在页面中调用它</li></ul></ul><div><br/></div><div><br/></div><div>作业：</div><div><ul><li><span style="font-size: 10pt;">使用中间件完成数据统计，每个IP只统计一次</span></li><ul><li><span style="font-size: 10pt;">获取IP使用以下方式</span></li></ul></ul><div><br/></div></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">if request.META.has_key('HTTP_X_FORWARDED_FOR'):  </span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    ip =  request.META['HTTP_X_FORWARDED_FOR']  </span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">else:  </span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    ip = request.META['REMOTE_ADDR']  </span></div></div><div><br/></div><div><div><br/></div><ul><li><span style="font-size: 13.3333px;">使用上下文渲染器完成首页菜单栏</span></li></ul><div><br/></div></div><div><br/></div></div><div style="margin-top: 1em; margin-bottom: 1em;"><br/></div><div style="margin-top: 1em; margin-bottom: 1em;"><div><br/></div><div><br/></div></div><div><span style="font-size: 16pt; font-family: Tahoma;">  </span></div></div><div><br/></div></span>
</div></body></html> 